openecualliance: "1.0"
id: emerald-lg
name: "Emerald K6/M3D ECU Log"
version: "1.0.0"
vendor: emerald
description: |
  Parses binary log files from Emerald K6 and M3D ECUs.

  Emerald ECUs use a dual-file format:
  - .lg2 file: Text file containing channel definitions (which parameters are logged)
  - .lg1 file: Binary file containing timestamped data records

  Both files must be present with the same base name. The LG2 file uses an INI-like
  format with [chan1] through [chan8] sections mapping to internal channel IDs.
  The LG1 file contains 24-byte records (8-byte OLE timestamp + 8 x 2-byte u16 values).

  Popular in UK tuning scene for classic car ECU conversions.
website: "https://www.emeraldm3d.co.uk"

file_format:
  type: binary
  extensions: [".lg1", ".lg2"]
  endianness: little
  header_size: 0
  record_size: fixed
  specification_url: null
  notes: |
    Requires both .lg1 (data) and .lg2 (channel definitions) files.
    LG1 records are 24 bytes: 8-byte f64 OLE timestamp + 8 x 2-byte u16 values.
    Channel values are scaled: (raw_value * scale) + offset.

channels:
  # Core Engine Parameters
  - id: rpm
    name: "Engine RPM"
    description: "Engine crankshaft rotational speed"
    category: engine
    data_type: float
    unit: rpm
    min: 0
    max: 12000
    precision: 0
    source_names:
      - "RPM"
    internal_id: 20

  - id: tps
    name: "Throttle Position"
    description: "Throttle position sensor percentage"
    category: engine
    data_type: float
    unit: percent
    min: 0
    max: 100
    precision: 1
    source_names:
      - "TPS"
    internal_id: 1

  - id: map
    name: "Manifold Pressure"
    description: "Manifold absolute pressure"
    category: pressure
    data_type: float
    unit: kpa
    min: 0
    max: 400
    precision: 1
    source_names:
      - "MAP"
    internal_id: [3, 32]

  - id: load
    name: "Engine Load"
    description: "Calculated engine load"
    category: engine
    data_type: float
    unit: percent
    min: 0
    max: 200
    precision: 1
    source_names:
      - "Load"
    internal_id: 12

  - id: barometric
    name: "Barometric Pressure"
    description: "Ambient barometric pressure"
    category: pressure
    data_type: float
    unit: kpa
    min: 80
    max: 110
    precision: 1
    source_names:
      - "Barometric Pressure"
    internal_id: 33

  # Fuel System
  - id: lambda
    name: "Lambda"
    description: "Wideband lambda sensor reading"
    category: fuel
    data_type: float
    unit: lambda
    min: 0.5
    max: 1.5
    precision: 3
    source_names:
      - "Lambda"
    internal_id: [4, 47]

  - id: afr
    name: "Air-Fuel Ratio"
    description: "Air-fuel ratio (stoich = 14.7 for gasoline)"
    category: fuel
    data_type: float
    unit: afr
    min: 8
    max: 22
    precision: 1
    source_names:
      - "AFR"
    internal_id: [45, 46]

  - id: afr_target
    name: "Target AFR"
    description: "ECU target air-fuel ratio"
    category: fuel
    data_type: float
    unit: afr
    min: 8
    max: 22
    precision: 1
    source_names:
      - "AFR Target"
    internal_id: 18

  - id: pulse_width
    name: "Injector Pulse Width"
    description: "Fuel injector open time"
    category: fuel
    data_type: float
    unit: milliseconds
    min: 0
    max: 50
    precision: 2
    source_names:
      - "Inj Pulse Width"
    internal_id: 22

  - id: duty_cycle
    name: "Injector Duty Cycle"
    description: "Fuel injector duty cycle percentage"
    category: fuel
    data_type: float
    unit: percent
    min: 0
    max: 100
    precision: 1
    source_names:
      - "Inj Duty Cycle"
      - "Inj Duty"
    internal_id: [23, 31]

  - id: fuel_pressure
    name: "Fuel Pressure"
    description: "Fuel rail pressure"
    category: pressure
    data_type: float
    unit: bar
    min: 0
    max: 10
    precision: 2
    source_names:
      - "Fuel Pressure"
    internal_id: [5, 24]

  - id: fuel_cut
    name: "Fuel Cut"
    description: "Fuel cut active flag"
    category: fuel
    data_type: bool
    unit: ""
    source_names:
      - "Fuel Cut"
    internal_id: 13

  # Ignition System
  - id: ignition_advance
    name: "Ignition Advance"
    description: "Spark timing advance"
    category: ignition
    data_type: float
    unit: degrees
    min: -20
    max: 60
    precision: 1
    source_names:
      - "Ignition Advance"
      - "Ignition Timing"
    internal_id: [21, 29]

  - id: spark_cut
    name: "Spark Cut"
    description: "Spark cut active flag"
    category: ignition
    data_type: bool
    unit: ""
    source_names:
      - "Spark Cut"
    internal_id: 14

  # Temperature Sensors
  - id: coolant_temp
    name: "Coolant Temperature"
    description: "Engine coolant temperature"
    category: temperature
    data_type: float
    unit: celsius
    min: -40
    max: 150
    precision: 0
    source_names:
      - "Coolant Temp"
    internal_id: 19

  - id: iat
    name: "Intake Air Temperature"
    description: "Intake air temperature"
    category: temperature
    data_type: float
    unit: celsius
    min: -40
    max: 80
    precision: 0
    source_names:
      - "Air Temp"
    internal_id: 2

  - id: oil_temp
    name: "Oil Temperature"
    description: "Engine oil temperature"
    category: temperature
    data_type: float
    unit: celsius
    min: -40
    max: 180
    precision: 0
    source_names:
      - "Oil Temp"
    internal_id: 7

  - id: fuel_temp
    name: "Fuel Temperature"
    description: "Fuel temperature"
    category: temperature
    data_type: float
    unit: celsius
    min: -40
    max: 80
    precision: 0
    source_names:
      - "Fuel Temp"
    internal_id: 8

  - id: exhaust_temp
    name: "Exhaust Temperature"
    description: "Exhaust gas temperature"
    category: temperature
    data_type: float
    unit: celsius
    min: 0
    max: 1200
    precision: 0
    source_names:
      - "Exhaust Temp"
    internal_id: 9

  # Pressure Sensors
  - id: oil_pressure
    name: "Oil Pressure"
    description: "Engine oil pressure"
    category: pressure
    data_type: float
    unit: bar
    min: 0
    max: 10
    precision: 2
    source_names:
      - "Oil Pressure"
    internal_id: 6

  # Boost Control
  - id: boost_target
    name: "Boost Target"
    description: "Target boost pressure"
    category: pressure
    data_type: float
    unit: kpa
    min: 0
    max: 300
    precision: 1
    source_names:
      - "Boost Target"
    internal_id: 10

  - id: boost_duty
    name: "Boost Duty"
    description: "Boost control solenoid duty cycle"
    category: pressure
    data_type: float
    unit: percent
    min: 0
    max: 100
    precision: 1
    source_names:
      - "Boost Duty"
    internal_id: 11

  # Electrical
  - id: battery_voltage
    name: "Battery Voltage"
    description: "System battery voltage"
    category: electrical
    data_type: float
    unit: volts
    min: 0
    max: 20
    precision: 2
    source_names:
      - "Battery"
    internal_id: 17

  # Speed & Drivetrain
  - id: vehicle_speed
    name: "Vehicle Speed"
    description: "Vehicle speed from ECU"
    category: speed
    data_type: float
    unit: kph
    min: 0
    max: 300
    precision: 1
    source_names:
      - "Speed"
    internal_id: 16

  - id: gear
    name: "Gear Position"
    description: "Current gear (calculated or from sensor)"
    category: drivetrain
    data_type: int
    unit: ""
    min: 0
    max: 8
    precision: 0
    source_names:
      - "Gear"
    internal_id: 15

  # Fuel Corrections
  - id: clt_correction
    name: "Coolant Temp Correction"
    description: "Fuel correction based on coolant temperature"
    category: correction
    data_type: float
    unit: percent
    min: -50
    max: 100
    precision: 1
    source_names:
      - "Coolant Temp Corr"
    internal_id: 25

  - id: iat_correction
    name: "Air Temp Correction"
    description: "Fuel correction based on intake air temperature"
    category: correction
    data_type: float
    unit: percent
    min: -50
    max: 50
    precision: 1
    source_names:
      - "Air Temp Corr"
    internal_id: 26

  - id: accel_enrichment
    name: "Acceleration Enrichment"
    description: "Transient fuel enrichment during acceleration"
    category: correction
    data_type: float
    unit: percent
    min: 0
    max: 200
    precision: 1
    source_names:
      - "Acceleration Enrich"
    internal_id: 27

  - id: warmup_enrichment
    name: "Warmup Enrichment"
    description: "Cold start fuel enrichment"
    category: correction
    data_type: float
    unit: percent
    min: 0
    max: 200
    precision: 1
    source_names:
      - "Warmup Enrich"
    internal_id: 28

  # Idle Control
  - id: idle_valve
    name: "Idle Valve Position"
    description: "Idle air control valve position"
    category: engine
    data_type: float
    unit: percent
    min: 0
    max: 100
    precision: 1
    source_names:
      - "Idle Valve"
    internal_id: 30

  # Auxiliary Inputs
  - id: aux_input_1
    name: "Auxiliary Input 1"
    description: "Generic auxiliary input channel"
    category: custom
    data_type: float
    unit: ""
    source_names:
      - "Aux Input 34"
    internal_id: 34

  - id: aux_input_2
    name: "Auxiliary Input 2"
    description: "Generic auxiliary input channel"
    category: custom
    data_type: float
    unit: ""
    source_names:
      - "Aux Input 35"
    internal_id: 35

metadata:
  author: "OpenECU Alliance"
  license: "CC BY 4.0"
  tested_with:
    - "Emerald K6"
    - "Emerald M3D"
  known_issues:
    - "Requires both .lg1 and .lg2 files with same base name"
    - "Limited to 8 channels per log session"
    - "Some channel IDs may vary between firmware versions"
  changelog:
    - version: "1.0.0"
      date: "2025-01-05"
      changes:
        - "Initial release with 32 known channel definitions"
        - "Covers Emerald K6 and M3D ECUs"
