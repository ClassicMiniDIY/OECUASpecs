# OpenECU Alliance Adapter Specification
# RomRaider CSV Log Format (Subaru ECUs)

openecualliance: "1.0"
id: romraider-csv
name: "RomRaider CSV Log"
version: "1.0.0"
vendor: romraider
description: |
  CSV log files generated by RomRaider ECU logging software.
  Commonly used for Subaru ECUs with OpenPort cables.

  Format characteristics:
  - Comma (US locale) or semicolon (European locale) delimiter
  - European locale uses comma as decimal separator (e.g., "14,00")
  - First column is Time in milliseconds
  - Channel names include units in parentheses (e.g., "Engine Speed (rpm)")
  - Subaru-specific parameters like IAM, A/F Learning, etc.
website: "https://www.romraider.com"

file_format:
  type: csv
  extensions: [".csv", ".log"]
  encoding: utf-8
  delimiter: ","  # US locale; European uses semicolon
  header_row: 0
  data_start_row: 1
  timestamp_column: "Time"
  timestamp_unit: milliseconds

channels:
  # Engine Core
  - id: rpm
    name: "Engine RPM"
    description: "Engine speed from crankshaft sensor"
    category: engine
    data_type: float
    unit: rpm
    min: 0
    max: 9000
    precision: 0
    source_names:
      - "Engine Speed"
      - "Engine Speed (rpm)"
      - "RPM"
      - "RPM (rpm)"

  - id: tps
    name: "Throttle Position"
    description: "Throttle opening angle"
    category: engine
    data_type: float
    unit: percent
    min: 0
    max: 100
    precision: 1
    source_names:
      - "Throttle Opening Angle"
      - "Throttle Opening Angle (%)"
      - "Throttle Position"
      - "TPS"
      - "TPS (%)"

  - id: map
    name: "Manifold Pressure"
    description: "Manifold absolute/relative pressure"
    category: pressure
    data_type: float
    unit: psi
    min: -15
    max: 30
    precision: 2
    source_names:
      - "Manifold Relative Pressure"
      - "Manifold Relative Pressure (psi)"
      - "Manifold Absolute Pressure"
      - "MAP"
      - "MAP (psi)"

  - id: boost
    name: "Boost Pressure"
    description: "Boost pressure (gauge)"
    category: pressure
    data_type: float
    unit: psi
    min: -15
    max: 30
    precision: 2
    source_names:
      - "Boost"
      - "Boost (psi)"
      - "Boost Pressure"

  - id: load
    name: "Engine Load"
    description: "Calculated engine load"
    category: engine
    data_type: float
    unit: percent
    min: 0
    max: 200
    precision: 1
    source_names:
      - "Engine Load"
      - "Engine Load (%)"
      - "Load"
      - "Calculated Load"
      - "Engine Load (Relative) (%)"

  # Fuel System - Subaru Specific
  - id: afr
    name: "Air-Fuel Ratio"
    description: "Measured air-fuel ratio"
    category: fuel
    data_type: float
    unit: afr
    min: 10
    max: 20
    precision: 2
    source_names:
      - "A/F Sensor #1"
      - "A/F Sensor #1 (AFR)"
      - "AFR"
      - "Air/Fuel Ratio"
      - "Wideband AFR"

  - id: afr_correction
    name: "A/F Correction"
    description: "Short-term fuel trim from A/F sensor"
    category: correction
    data_type: float
    unit: percent
    min: -25
    max: 25
    precision: 1
    source_names:
      - "A/F Correction #1"
      - "A/F Correction #1 (%)"
      - "A/F Correction"
      - "STFT"
      - "Short Term Fuel Trim"

  - id: af_learning
    name: "A/F Learning"
    description: "Long-term fuel trim / A/F Learning value"
    category: correction
    data_type: float
    unit: percent
    min: -25
    max: 25
    precision: 1
    source_names:
      - "A/F Learning #1"
      - "A/F Learning #1 (%)"
      - "A/F Learning"
      - "LTFT"
      - "Long Term Fuel Trim"

  - id: maf
    name: "Mass Airflow"
    description: "Mass airflow sensor reading"
    category: engine
    data_type: float
    unit: g/s
    min: 0
    max: 500
    precision: 1
    source_names:
      - "Mass Airflow"
      - "Mass Airflow (g/s)"
      - "MAF"
      - "MAF (g/s)"

  - id: maf_voltage
    name: "MAF Voltage"
    description: "Mass airflow sensor voltage"
    category: electrical
    data_type: float
    unit: volts
    min: 0
    max: 5
    precision: 2
    source_names:
      - "Mass Airflow Sensor Voltage"
      - "Mass Airflow Sensor Voltage (V)"
      - "MAF Voltage"

  - id: injector_duty
    name: "Injector Duty Cycle"
    description: "Fuel injector duty cycle"
    category: fuel
    data_type: float
    unit: percent
    min: 0
    max: 100
    precision: 1
    source_names:
      - "Injector Duty Cycle"
      - "Injector Duty Cycle (%)"
      - "IDC"
      - "Fuel Injector #1 Pulse Width (ms)"

  # Ignition System
  - id: ignition_advance
    name: "Ignition Timing"
    description: "Ignition timing advance"
    category: ignition
    data_type: float
    unit: degrees
    min: -20
    max: 60
    precision: 1
    source_names:
      - "Ignition Timing"
      - "Ignition Timing (degrees)"
      - "Timing Advance"
      - "Timing Advance (degrees)"
      - "Spark Advance"

  # Subaru-Specific Knock/IAM
  - id: iam
    name: "IAM"
    description: "Ignition Advance Multiplier (Subaru learning value)"
    category: correction
    data_type: float
    unit: multiplier
    min: 0
    max: 1
    precision: 3
    source_names:
      - "IAM"
      - "Ignition Advance Multiplier"

  - id: fine_knock_learning
    name: "Fine Knock Learning"
    description: "Fine knock learning value per cylinder"
    category: correction
    data_type: float
    unit: degrees
    min: -10
    max: 10
    precision: 2
    source_names:
      - "Fine Knock Learn"
      - "Fine Knock Learn (degrees)"
      - "Fine Knock Learning"
      - "FKL"

  - id: feedback_knock
    name: "Feedback Knock Correction"
    description: "Real-time knock retard"
    category: correction
    data_type: float
    unit: degrees
    min: -20
    max: 0
    precision: 2
    source_names:
      - "Feedback Knock Correction"
      - "Feedback Knock Correction (degrees)"
      - "Knock Correction"
      - "FBKC"

  - id: dam
    name: "DAM"
    description: "Dynamic Advance Multiplier"
    category: correction
    data_type: float
    unit: multiplier
    min: 0
    max: 1
    precision: 3
    source_names:
      - "DAM"
      - "Dynamic Advance Multiplier"
      - "Dynamic Adv Multiplier"

  # Temperature Sensors
  - id: coolant_temp
    name: "Coolant Temperature"
    description: "Engine coolant temperature"
    category: temperature
    data_type: float
    unit: celsius
    min: -40
    max: 150
    precision: 1
    source_names:
      - "Coolant Temperature"
      - "Coolant Temperature (C)"
      - "ECT"
      - "Engine Coolant Temp"

  - id: iat
    name: "Intake Air Temperature"
    description: "Intake air temperature"
    category: temperature
    data_type: float
    unit: celsius
    min: -40
    max: 100
    precision: 1
    source_names:
      - "Intake Air Temperature"
      - "Intake Air Temperature (C)"
      - "IAT"
      - "IAT (C)"

  # Electrical
  - id: battery_voltage
    name: "Battery Voltage"
    description: "System battery voltage"
    category: electrical
    data_type: float
    unit: volts
    min: 0
    max: 20
    precision: 2
    source_names:
      - "Battery Voltage"
      - "Battery Voltage (V)"
      - "Battery"

  # Speed
  - id: vehicle_speed
    name: "Vehicle Speed"
    description: "Vehicle ground speed"
    category: speed
    data_type: float
    unit: mph
    min: 0
    max: 200
    precision: 0
    source_names:
      - "Vehicle Speed"
      - "Vehicle Speed (mph)"
      - "Speed"
      - "VSS"

  - id: gear
    name: "Gear Position"
    description: "Current gear"
    category: drivetrain
    data_type: int
    unit: gear
    min: 0
    max: 6
    precision: 0
    source_names:
      - "Gear Position"
      - "Gear"
      - "Current Gear"

  # Turbo/Boost Control (Subaru)
  - id: wastegate_duty
    name: "Wastegate Duty"
    description: "Wastegate solenoid duty cycle"
    category: engine
    data_type: float
    unit: percent
    min: 0
    max: 100
    precision: 1
    source_names:
      - "Wastegate Duty"
      - "Wastegate Duty (%)"
      - "WG Duty"

  - id: target_boost
    name: "Target Boost"
    description: "Target boost pressure from ECU"
    category: pressure
    data_type: float
    unit: psi
    min: 0
    max: 30
    precision: 2
    source_names:
      - "Target Boost"
      - "Target Boost (psi)"
      - "Boost Target"

  # System
  - id: time
    name: "Time"
    description: "Log timestamp in milliseconds"
    category: system
    data_type: float
    unit: milliseconds
    precision: 0
    source_names:
      - "Time"
      - "Time (msec)"
      - "Time (ms)"
      - "Timestamp"

  # PLX External Sensors (common with RomRaider)
  - id: plx_afr
    name: "PLX AFR"
    description: "PLX wideband AFR sensor"
    category: fuel
    data_type: float
    unit: afr
    min: 10
    max: 20
    precision: 2
    source_names:
      - "PLX AFR"
      - "PLX AFR (AFR)"
      - "PLX Wideband"

  - id: plx_egt
    name: "PLX EGT"
    description: "PLX exhaust gas temperature"
    category: temperature
    data_type: float
    unit: celsius
    min: 0
    max: 1200
    precision: 0
    source_names:
      - "PLX EGT"
      - "PLX EGT (C)"
      - "PLX Exhaust Gas Temp"

  - id: plx_boost
    name: "PLX Boost"
    description: "PLX boost/vacuum sensor"
    category: pressure
    data_type: float
    unit: bar
    min: -1
    max: 3
    precision: 2
    source_names:
      - "PLX Manifold Absolute Pressure"
      - "PLX Manifold Absolute Pressure (bar)"
      - "PLX Boost"

metadata:
  author: "OpenECU Alliance"
  license: "MIT"
  tested_with:
    - "Subaru WRX/STI (2002-2021)"
    - "Subaru Legacy GT"
    - "Subaru Forester XT"
  known_issues:
    - "European locale files use semicolon delimiter and comma decimal separator"
    - "Units in header may vary based on RomRaider settings"
    - "PLX sensor channels require PLX iMFD connected"
  changelog:
    - version: "1.0.0"
      date: "2025-01-04"
      changes:
        - "Initial release"
        - "Support for Subaru-specific knock learning parameters"
        - "Support for PLX external sensors"

# RomRaider-specific extensions
x_romraider:
  european_locale_support: true
  units_in_parentheses: true
  subaru_specific_channels: ["iam", "dam", "fine_knock_learning", "feedback_knock"]
