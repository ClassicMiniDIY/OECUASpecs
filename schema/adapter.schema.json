{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://openecualliance.org/schema/adapter.schema.json",
  "title": "OpenECU Alliance Adapter",
  "description": "Schema for OpenECU Alliance adapter specification files",
  "type": "object",
  "required": ["openecualliance", "id", "name", "version", "vendor", "file_format", "channels"],
  "properties": {
    "openecualliance": {
      "type": "string",
      "description": "Specification version",
      "pattern": "^[0-9]+\\.[0-9]+$",
      "examples": ["1.0"]
    },
    "id": {
      "type": "string",
      "description": "Unique adapter identifier",
      "pattern": "^[a-z0-9]+(-[a-z0-9]+)*$",
      "examples": ["haltech-nsp", "link-llg", "aim-xrk"]
    },
    "name": {
      "type": "string",
      "description": "Human-readable adapter name",
      "minLength": 1,
      "examples": ["Haltech NSP CSV Export"]
    },
    "version": {
      "type": "string",
      "description": "Adapter version (semver)",
      "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+(-[a-zA-Z0-9.]+)?(\\+[a-zA-Z0-9.]+)?$",
      "examples": ["1.0.0", "2.1.0-beta.1"]
    },
    "vendor": {
      "type": "string",
      "description": "ECU vendor/manufacturer",
      "minLength": 1,
      "examples": ["haltech", "link", "aim", "ecumaster"]
    },
    "description": {
      "type": "string",
      "description": "Detailed description of the adapter"
    },
    "website": {
      "type": "string",
      "format": "uri",
      "description": "URL for more information"
    },
    "file_format": {
      "type": "object",
      "description": "File format specification",
      "required": ["type", "extensions"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["csv", "binary"],
          "description": "File format type"
        },
        "extensions": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^\\.[a-zA-Z0-9]+$"
          },
          "minItems": 1,
          "description": "Valid file extensions"
        },
        "encoding": {
          "type": "string",
          "default": "utf-8",
          "description": "File encoding"
        },
        "delimiter": {
          "type": "string",
          "description": "Column delimiter (CSV only)"
        },
        "quote_char": {
          "type": "string",
          "default": "\"",
          "description": "Quote character (CSV only)"
        },
        "escape_char": {
          "type": "string",
          "default": "\\",
          "description": "Escape character (CSV only)"
        },
        "header_row": {
          "type": "integer",
          "minimum": 0,
          "description": "0-indexed row containing headers (CSV only)"
        },
        "unit_row": {
          "type": "integer",
          "minimum": 0,
          "description": "Row containing unit labels (CSV only)"
        },
        "data_start_row": {
          "type": "integer",
          "minimum": 0,
          "description": "First row of data (CSV only)"
        },
        "comment_prefix": {
          "type": "string",
          "description": "Comment line prefix (CSV only)"
        },
        "timestamp_column": {
          "type": "string",
          "description": "Name of timestamp column"
        },
        "timestamp_unit": {
          "type": "string",
          "enum": ["seconds", "milliseconds", "microseconds"],
          "description": "Unit of timestamp values"
        },
        "endianness": {
          "type": "string",
          "enum": ["little", "big"],
          "description": "Byte order (binary only)"
        },
        "magic_bytes": {
          "type": "array",
          "items": {
            "type": "integer",
            "minimum": 0,
            "maximum": 255
          },
          "description": "File signature bytes (binary only)"
        },
        "header_size": {
          "type": "integer",
          "minimum": 0,
          "description": "Header size in bytes (binary only)"
        },
        "record_size": {
          "type": "string",
          "enum": ["fixed", "variable"],
          "description": "Record size type (binary only)"
        },
        "specification_url": {
          "type": "string",
          "format": "uri",
          "description": "Link to format documentation (binary only)"
        }
      },
      "allOf": [
        {
          "if": {
            "properties": { "type": { "const": "csv" } }
          },
          "then": {
            "required": ["delimiter", "header_row", "data_start_row"]
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "binary" } }
          },
          "then": {
            "required": ["endianness"]
          }
        }
      ]
    },
    "channels": {
      "type": "array",
      "description": "Channel definitions",
      "minItems": 1,
      "items": {
        "$ref": "#/definitions/channel"
      }
    },
    "metadata": {
      "type": "object",
      "description": "Additional metadata",
      "properties": {
        "author": {
          "type": "string",
          "description": "Adapter author"
        },
        "license": {
          "type": "string",
          "description": "Adapter license"
        },
        "repository": {
          "type": "string",
          "format": "uri",
          "description": "Source repository URL"
        },
        "tested_with": {
          "type": "array",
          "items": { "type": "string" },
          "description": "ECU models tested with this adapter"
        },
        "known_issues": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Known issues or limitations"
        },
        "changelog": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["version", "date", "changes"],
            "properties": {
              "version": { "type": "string" },
              "date": { "type": "string", "format": "date" },
              "changes": {
                "type": "array",
                "items": { "type": "string" }
              }
            }
          }
        }
      },
      "additionalProperties": true
    }
  },
  "patternProperties": {
    "^x_": {
      "description": "Custom extension fields"
    }
  },
  "additionalProperties": false,
  "definitions": {
    "channel": {
      "type": "object",
      "required": ["id", "name", "category", "data_type", "unit", "source_names"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Canonical channel identifier",
          "pattern": "^[a-z][a-z0-9_]*$",
          "examples": ["rpm", "coolant_temp", "afr_1"]
        },
        "name": {
          "type": "string",
          "description": "Human-readable display name",
          "minLength": 1,
          "examples": ["Engine RPM", "Coolant Temperature"]
        },
        "description": {
          "type": "string",
          "description": "Detailed description of the channel"
        },
        "category": {
          "type": "string",
          "enum": [
            "engine",
            "fuel",
            "ignition",
            "temperature",
            "pressure",
            "electrical",
            "speed",
            "drivetrain",
            "correction",
            "system",
            "acceleration",
            "rotation",
            "position",
            "suspension",
            "timing",
            "traction",
            "driver_input",
            "custom"
          ],
          "description": "Channel category"
        },
        "data_type": {
          "type": "string",
          "enum": ["float", "int", "bool", "string", "enum"],
          "description": "Data type of values"
        },
        "enum_values": {
          "type": "array",
          "description": "Possible values for enum type",
          "items": {
            "type": "object",
            "required": ["value", "label"],
            "properties": {
              "value": {
                "type": ["integer", "string"]
              },
              "label": {
                "type": "string"
              }
            }
          }
        },
        "unit": {
          "type": "string",
          "description": "Canonical unit",
          "examples": ["rpm", "celsius", "kpa", "percent"]
        },
        "min": {
          "type": "number",
          "description": "Minimum valid value"
        },
        "max": {
          "type": "number",
          "description": "Maximum valid value"
        },
        "precision": {
          "type": "integer",
          "minimum": 0,
          "default": 2,
          "description": "Decimal places for display"
        },
        "source_names": {
          "type": "array",
          "description": "Vendor-specific names in log files",
          "items": { "type": "string" },
          "minItems": 1
        },
        "source_unit": {
          "type": "string",
          "description": "Unit of source data if different from canonical"
        },
        "conversion": {
          "type": "string",
          "description": "Formula to convert from source to canonical unit",
          "examples": ["(x - 32) * 5/9", "x * 6.89476"]
        },
        "tags": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Searchable tags"
        }
      },
      "allOf": [
        {
          "if": {
            "properties": { "data_type": { "const": "enum" } }
          },
          "then": {
            "required": ["enum_values"]
          }
        }
      ],
      "additionalProperties": false
    }
  }
}
